<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decentralized Poll System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Decentralized Poll System</h1>
        <div id="login" class="text-center my-4">
            <button class="btn btn-primary" onclick="connectMetaMask()">Login with MetaMask</button>
        </div>
        <div id="admin-section" style="display:none;">
            <h2>Create a New Poll</h2>
            <form id="create-poll-form">
                <div class="mb-3">
                    <label for="poll-title" class="form-label">Poll Title</label>
                    <input type="text" class="form-control" id="poll-title" required>
                </div>
                <div class="mb-3">
                    <label for="poll-options" class="form-label">Poll Options (comma-separated)</label>
                    <input type="text" class="form-control" id="poll-options" required>
                </div>
                <button type="submit" class="btn btn-success">Create Poll</button>
            </form>
            <h3 class="mt-4">All Polls</h3>
            <div id="poll-list"></div>
        </div>
        <div id="user-section" style="display:none;">
            <h2>Available Polls</h2>
            <div id="poll-list-user"></div>
        </div>
    </div>

    <script>
        let web3;
        let contract;
        let userAddress;

        const contractAddress = "0x171052533faDD294E210d262C93eFE883A6Ae7E4";
        const abi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"pollId","type":"uint256"},{"indexed":false,"internalType":"string","name":"title","type":"string"}],"name":"PollCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"pollId","type":"uint256"}],"name":"PollDeleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"pollId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"optionId","type":"uint256"},{"indexed":false,"internalType":"address","name":"voter","type":"address"}],"name":"Voted","type":"event"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"title","type":"string"},{"internalType":"string[]","name":"options","type":"string[]"}],"name":"createPoll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"pollId","type":"uint256"}],"name":"deletePoll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"pollId","type":"uint256"}],"name":"getPoll","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string[]","name":"","type":"string[]"},{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pollCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"polls","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"title","type":"string"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"pollId","type":"uint256"},{"internalType":"uint256","name":"optionId","type":"uint256"}],"name":"vote","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        async function connectMetaMask() {
            if (window.ethereum) {
                try {
                    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
                    userAddress = accounts[0];
                    web3 = new Web3(window.ethereum);
                    contract = new web3.eth.Contract(abi, contractAddress);
                    document.getElementById("login").style.display = "none";

                    const adminAddress = await contract.methods.admin().call();
                    if (userAddress.toLowerCase() === adminAddress.toLowerCase()) {
                        document.getElementById("admin-section").style.display = "block";
                        loadPollsForAdmin();
                    } else {
                        document.getElementById("user-section").style.display = "block";
                        loadPollsForUser();
                    }
                } catch (error) {
                    console.error("MetaMask connection failed", error);
                }
            } else {
                alert("Please install MetaMask!");
            }
        }

        async function loadPollsForAdmin() {
            const pollCount = await contract.methods.pollCounter().call();
            const pollList = document.getElementById("poll-list");
            pollList.innerHTML = "";
            for (let i = 1; i <= pollCount; i++) {
                const poll = await contract.methods.getPoll(i).call();
                const pollDiv = document.createElement("div");
                pollDiv.className = "mb-3";
                pollDiv.innerHTML = `
                    <h4>${poll[0]}</h4>
                    <p>${poll[1].join(", ")}</p>
                    <button class="btn btn-danger" onclick="deletePoll(${i})">Delete</button>
                `;
                pollList.appendChild(pollDiv);
            }
        }

        async function loadPollsForUser() {
            const pollCount = await contract.methods.pollCounter().call();
            const pollList = document.getElementById("poll-list-user");
            pollList.innerHTML = "";
            for (let i = 1; i <= pollCount; i++) {
                const poll = await contract.methods.getPoll(i).call();
                const pollDiv = document.createElement("div");
                pollDiv.className = "mb-3";
                pollDiv.innerHTML = `
                    <h4>${poll[0]}</h4>
                    ${poll[1].map((option, index) => `<button class="btn btn-primary me-2" onclick="vote(${i}, ${index})">${option}</button>`).join(" ")}
                `;
                pollList.appendChild(pollDiv);
            }
        }

        async function deletePoll(pollId) {
            await contract.methods.deletePoll(pollId).send({ from: userAddress });
            loadPollsForAdmin();
        }

        async function vote(pollId, optionId) {
            await contract.methods.vote(pollId, optionId).send({ from: userAddress });
            loadPollsForUser();
        }

        document.getElementById("create-poll-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("poll-title").value;
            const options = document.getElementById("poll-options").value.split(",").map(opt => opt.trim());
            await contract.methods.createPoll(title, options).send({ from: userAddress });
            loadPollsForAdmin();
        });
    </script>
</body>
</html>
